@using CareerExplorer.Core.Entities;
@using CareerExplorer.Web.DTO;
@using Microsoft.AspNetCore.Identity;
@using CareerExplorer.Shared;
@using Microsoft.AspNetCore.Mvc.Localization
@model VacancyDTO

@inject UserManager<IdentityUser> UserManager
@inject IViewLocalizer Localizer
<div class="container-md">
    <div class="row">
        <div class="col-md-8">

            <h1>@Model.Position.Name</h1>
            <span>@Model.CreatorNickName</span>
            <p>@Model.Description</p>
            <span>Published: @Model.CreatedDate.ToShortDateString()</span>
            @if (User.IsInRole(UserRoles.JobSeeker))
            {
                    @if(!Model.IsApplied)
                    {
                        @if (ViewBag.IsProfileAccepted && ViewBag.IsProfileFilled)
                        {
                    <div id="apply-container">
                        <button class="btn btn-primary mt-3 mb-3" id="apply-button">@Localizer["Apply"]</button>
                    <form id="application-form" style="display:none;">
                        <input id="id-input" name="vacancyId" value="@Model.Id" type="hidden">
                            <label for="file-input" class="form-label mt-4">@Localizer["Attach"]</label>
                            <input class="form-control" type="file" id="file-input">
                            <button style="display:block" class="btn btn-primary mt-3" id="apply-btn" type="post">@Localizer["Submit"]</button>
                    </form>
                    </div>
                        }
                        else
                        {
                            <p class="text-danger mt-2">To apply fill your profile.</p>
                            <a style="display:inline-block" class="btn btn-primary" asp-controller="JobSeekerProfile" asp-action="GetProfile">Go to profile</a>
                        }

                    }
                    else
                    {
                        <button style="display:block" class="btn btn-primary mt-3" disabled>@Localizer["Applied"]</button>
                    }
               
            }
        </div>
        <div class="col-md-4">

        </div>
    </div>
</div>
@if(User.IsInRole(UserRoles.JobSeeker))
{
    var user = await UserManager.GetUserAsync(User);
    if(user is AppUser)
    {
        var jobSeekerProfile = ((AppUser)user).JobSeekerProfile;
        if(!jobSeekerProfile.IsSubscribedToNotification)
        {
            <div class="modal" id="notification-modal">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <p>Subscribe to receive new vacancies.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="subscribe-btn">Subscribe</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" >Close</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $("#apply-button").click(function () {
            $("#application-form").show();
        });
    });

    $(document).ready(function () {
        $('#apply-btn').click(function (e) {
            e.preventDefault();
            var formData = new FormData();
            var fileInput = $('#file-input')[0];
            var file = fileInput.files[0];
            var allowedExtensions = ['pdf'];

            if (file && file.size > 0) {
                var extension = file.name.split('.').pop().toLowerCase();
                if (allowedExtensions.indexOf(extension) === -1) {
                    alert('Invalid file extension. Please select a PDF file.');
                    return;
                }
                formData.append('file', file);
                formData.append('vacancyId', document.getElementById('id-input').value);
                $.ajax({
                    url: '/JobSeekerProfile/Apply',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        $('#apply-btn').text('@Localizer["Sent"]');
                        $('#apply-btn').prop('disabled', true);
                        $('#file-input').prop('disabled', true);
                        $('#notification-modal').modal('show');
                    },
                    error: function () {
                        alert('An error occurred while submitting your application. Please try again later.');
                    }
                });
            } else {
                alert('Please select a file to upload.');
            }
        });
    });
    $(document).ready(function () {
        $("#subscribe-btn").click(function () {
            $.ajax({
                url: '/Notifications/Subscribe',
                type: 'POST',
                success: function (response) {
                    $('#notification-modal').modal('hide');
                },
                error: function () {
                    alert('An error occurred while subscribing to notifications. Please try again later.');
                }
            });
        });
    });
</script>


