@using CareerExplorer.Core.Entities;
@model IEnumerable<Message>
<div>
    <div id="messages">
        @foreach (var message in Model)
        {
            <div class="message @(message.SenderId == ViewBag.SenderId ? "me" : "other")">
                @message.Text
            </div>
        }
    </div>
    <form id="sendForm" style="position:static;">
        <input class="form-control" style="width:91%;display:inline-block" type="text" id="messageInput"
        placeholder="Message"/>
        <button class="btn btn-primary" id="sendButton" type="submit" disabled>Send</button>
    </form>
    </div>
    

</div>
<script src="~/js/signalr/dist/browser/signalr.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();
    
    document.getElementById("sendForm").addEventListener("submit", event => {
        event.preventDefault();
        const chatId = @ViewBag.ChatId;
        const senderId = "@ViewBag.SenderId";
        const receiverId = "@ViewBag.ReceiverId";
        const content = document.getElementById("messageInput").value;
        document.getElementById("messageInput").value = "";
        connection.invoke("SendMessage", chatId, senderId, receiverId, content)
         .catch(function (err) {
                    return console.error(err.toString());
         });
    });
    const viewSenderId = "@ViewBag.SenderId";

    connection.on("ReceiveMessage", function (messageText, senderId) {
        var div = document.createElement("div");
        div.textContent = messageText;
        if (senderId === viewSenderId) {
            $(div).addClass("message me");
        }
        else {
            $(div).addClass("message other");
        }
        document.getElementById("messages").appendChild(div);
    });
   
    connection.start()
        .then(function () {
            document.getElementById("sendButton").disabled = false;
        }).catch(function (err) {
        return console.error(err.toString());
    });

   
</script>
<style>
    #messages {
        height: 70%;
        height:30em;
        overflow-y: scroll;
        padding: 10px;
    }

    .message {
        display: block;
        background-color: #fff;
        border-radius:7%;
        padding: 10px;
        margin-bottom: 5px;
    }

        .message.me {
            float: right;
            margin-left:48%;
            background-color: #000;
            color: #fff;
        }

        .message.other {
            float: left;
            margin-right: 48%;
            color: #fff;
            background-color: #343a40;
        }
</style>
